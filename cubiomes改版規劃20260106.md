# Cubiomes 改版規劃 2026-01-06

## 背景
目前專案依賴 mcseedmap.net 的閉源 WASM 與預計算 btree。此方案存在版本更新落後、格式閉源與無法自建資料的風險。

## 目標
- 改用 Cubiomes（MIT）產生生態系地圖
- 不再依賴 btree 檔案
- 支援 1.18 - 1.21.x，並可快速跟進未來版本
- 維持現有前端架構（Vue 3 + TS + Vite + Leaflet）

## 範圍
- 替換 mcseedmap WASM worker 與 btree 流程
- 提供 JS binding 與 Web Worker 介面（Comlink）
- 實作 biome id -> 顏色映射
- 效能評估與回歸比對

不包含：UI 改版、Leaflet tile 管線重寫、資料包系統改動。

## 風險與對策
- 效能風險：256x256 tile 即時計算負擔高
  - 對策：worker pool、批次生成、WASM O3
- 色彩對齊風險：Cubiomes 回傳 biome id，需自建映射
  - 對策：沿用 `src/config/biomeColors.ts` 色票與版本 alias
- Hillshade 為硬需求（視覺效果不可改變）
  - 對策：使用 Cubiomes 高度 API，沿用既有 hillshade 演算法與參數，並固定高度取樣策略與座標/縮放對應方式，以像素級驗證確認一致

## 架構概觀
- 目前流程：`src/MapLayers/McseedmapBiomeLayer.ts` -> worker -> mcseedmap.wasm + btree
- 目標流程：`src/MapLayers/McseedmapBiomeLayer.ts` -> new cubiomes worker -> cubiomes.wasm

## 實作步驟
### 1) 建置與封裝
- 加入 Cubiomes 原始碼（建議 vendor 子目錄）
- 新增 WASM 建置腳本（Emscripten）
- 設定 `-O3`、`-s WASM_BIGINT=1` 以支援 64-bit seed

### 2) C wrapper API 設計
建議接口（C 端）
- `init(version, dimension, largeBiomes)`
- `setSeed(int64)`
- `genBiomeIds(x, z, y, size, step, outPtr)`
- `genHeights(x, z, size, step, outPtr)`（或等價的 surface/height map 輸出，用於 hillshade）
- `biomeToString(id)`（或輸出 id->name JSON）

### 3) JS binding + Worker
- 新增 `src/cubiomes/cubiomes-worker.ts`（或 .js）
- Comlink 對外提供與現有 `SeedmapGenerator` 類似接口
- 先維持 `generateBiomeImage` 以減少主程式改動

### 4) 顏色映射
- 使用 `src/config/biomeColors.ts` 的色票
- 依 `src/util.ts` 的 `versionMetadata` 做版本 alias
- 先維持 BMP 輸出，確保渲染結果不變（後續若改 RGBA 必須做像素級一致性驗證）

### 5) 接入 Leaflet Tile
- 修改 `src/MapLayers/McseedmapBiomeLayer.ts`：
  - 改載入新的 worker + wasm
  - 移除 btree loading 與 `setBiomeTree`
  - 依需要調整 `generateBiomeImage` 的回傳格式

### 6) 效能與驗證
- 基準測試：每 tile 生成耗時（ms）與瓦片吞吐量
- 正確性驗證：挑選固定種子對照現有版本輸出，解碼成 RGBA 後做像素級差異檢查
- 覆蓋三維度：主世界 / 地獄 / 終界

#### 像素級驗證流程（建議）
- 建立固定測試清單：seed / 版本 / 維度 / 縮放 / tile 座標（至少 10-20 組）
- 以現有版本輸出作為 baseline，保存每個 tile 的 RGBA 陣列或 PNG
- 新版輸出同一組 tile，解碼成 RGBA
- 逐像素比對 RGBA 值（差異必須為 0）；輸出差異統計與差分圖（若有差異）
- 任何單一 tile 有差異即視為不通過

## 里程碑
- M1：可建置 cubiomes.wasm，worker 可初始化
- M2：能生成 256x256 biome id 並映射到顏色
- M3：Leaflet tile 可正確渲染（含 hillshade），與現有版本像素級一致
- M4：效能達標，替換 mcseedmap 流程完成

## 檔案清單（預計變動）
- 新增：`src/cubiomes/`（worker、binding、產物）
- 修改：`src/MapLayers/McseedmapBiomeLayer.ts`
- 參考：`src/config/biomeColors.ts`
- 參考：`src/util.ts`

## 驗收條件
- 不依賴 btree 檔案即可渲染生態系地圖
- 1.18 - 1.21.x 可正常切換並顯示
- 視覺效果與現有版本完全一致（像素級差異為 0）
- 256x256 tile 在一般桌機可流暢瀏覽

## 後續實驗：RGBA（完成現有規劃後再評估）
- 目標：確認 RGBA 是否能在不改變視覺效果的前提下提升效能或維持同級效能
- 驗收評估指標：
  - 像素一致性：指定種子/版本/維度/縮放下，RGBA 與 BMP 的像素差異為 0
  - Hillshade 一致性：陰影強度與輪廓細節無可見差異（可用像素級差異或差分圖檢查）
  - 效能不回退：同樣情境下，RGBA 的平均 tile 生成時間與 p95 不得劣於 BMP（或明確設定可接受的上限）
  - 資源使用：記憶體峰值與 GC/長任務次數不高於 BMP 基準
  - 交互體驗：地圖拖動/縮放無明顯掉幀或卡頓

## 已確認需求
- 必須保留 hillshade，渲染效果需與現有結果一致
- 維持 BMP 輸出（避免影像處理差異）
- 不支援舊版（1.17-）與 Bedrock
